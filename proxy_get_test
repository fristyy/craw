
import requests
from bs4 import BeautifulSoup 

import mysql.connector

proxyWeburl = 'http://www.data5u.com/'

target_url1 = 'https://www.baidu.com'
target_url2 = 'https://nvshenheji.com'

#端口破解,此网站浏览器显示端口与爬虫所取数据不一致，port后class属性字母串为端口的数据源。
#方法从简书https://www.jianshu.com/p/6d0f792da16a获取
#https://www.jianshu.com/u/vzFxb5,感谢'chaoswong'
def decrypt(src):
	s = 'ABCDEFGHIZ'
	dst = ''
	for c in src:
		dst += str(s.find(c))
	dst = int(dst) >> 3
	return dst

def ip_get(url):
    details = []
    ip_list =[]
    r = requests.get(proxyWeburl,headers=headers)
    bsobj = BeautifulSoup(r.text)
    for tag in bsobj.find_all('ul','l2'):
        details.append([str(detail.string) for detail in tag.find_all("li")])
        ip_list.append((tag.li.string,decrypt(tag.find_all("li", "port")[0]['class'][1])))
    return details,ip_list

#save in mysql db
def saveIndb(details):
    try:
        mydb = mysql.connector.connect(
        host = '127.0.0.1',
        port = 3306,
        user = 'root',
        password = '********',
        database = 'proxies'
        )
        mycursor = mydb.cursor()
        sql = '''INSERT INTO proxyies_ditails(ip,port,degree_of_anonymity,type,nation,
                     city,carrier_operator,speed_second,check_time) VALUES(%s,%s,%s,%s,%s,%s,%s,%s,%s)
                     ON DUPLICATE KEY UPDATE ip = ip'''
        
        mycursor.executemany(sql, ditails)      
    except Exception as e:
        mydb.rollback()
        print(e)
    finally:
        mydb.commit()
        mycursor.close()
        mydb.close()

ditails, iplist = ip_get(proxyWeburl)
#ditail replace real port
for i in range(len(ditails)):
    ditails[i][1]=str(iplist[i][1])
ditails = [tuple(proxy_ditail) for proxy_ditail in ditails]
print(len(ditails))
print(ditails)

saveIndb(ditails)

def ip_test(iplist):
    for server,port in ip_list:
        proxies = {'http://':'http://' + server +':' + port, 'https':'https://' + server +':' + port}
        try:
            r = requests.get(target_url1, proxies = proxies,headers=headers, timeout = 10)
            if r.status_code == 200:
                print(server,':request sucesses')
            else:
                print(server+':'+r.status_code)
        except:
            print(server,':bad proxy')
